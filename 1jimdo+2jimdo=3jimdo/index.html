<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>漢字記録ツール</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;margin:16px}
button{margin:4px}
.gallery{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.thumb-container{border:1px solid #ddd;padding:4px;width:150px;display:flex;flex-direction:column;align-items:center}
.thumb-container img{width:100%;height:auto}
</style>
</head>
<body>

<h1>漢字記録ツール</h1>
<p id="recordCount">記録数: 0</p>
<button id="captureBtn">画面キャプチャ</button>
<button id="clearBtn">全削除</button>

<div id="gallery" class="gallery"></div>

<script>
const entries = []; // {id, dataUrl, reading, memo, ts}

function saveToLocal(){
    localStorage.setItem('kanji_records', JSON.stringify(entries));
    updateRecordCount();
}

function loadFromLocal(){
    const raw = localStorage.getItem('kanji_records');
    if(raw){
        try{
            const arr = JSON.parse(raw);
            entries.splice(0, entries.length, ...arr);
            refreshGallery();
        }catch(e){ console.error('復元エラー:', e); }
    }
}

function updateRecordCount(){
    document.getElementById('recordCount').textContent = "記録数: " + entries.length;
}

function refreshGallery(){
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    entries.forEach((e,i)=>{
        const div = document.createElement('div');
        div.className = 'thumb-container';

        const img = document.createElement('img');
        img.src = e.dataUrl;
        div.appendChild(img);

        const reading = document.createElement('div');
        reading.textContent = "読み: " + e.reading;
        div.appendChild(reading);

        const memo = document.createElement('div');
        memo.textContent = "メモ: " + e.memo;
        div.appendChild(memo);

        gallery.appendChild(div);
    });
}

// 画面キャプチャと入力
document.getElementById('captureBtn').addEventListener('click', async ()=>{
    try{
        const element = document.body; // ページ全体をキャプチャ
        const canvas = await html2canvas(element);
        const dataUrl = canvas.toDataURL('image/png');

        const reading = prompt("読みを入力してください");
        if(reading === null) return;

        const memo = prompt("メモを入力してください") || '';

        entries.push({id: Date.now(), dataUrl, reading, memo, ts: Date.now()});
        saveToLocal();
        refreshGallery();
    }catch(e){ alert('スクリーンショットに失敗しました'); console.error(e); }
});

// 全削除
document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('全データを本当に削除しますか？')){
        entries.length = 0;
        saveToLocal();
        refreshGallery();
    }
});

// 初期化
loadFromLocal();
updateRecordCount();

</script>
</body>
</html>
