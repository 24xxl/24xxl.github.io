<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site not found · GitHub Pages</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo, sans-serif;margin:16px}
    button{margin:4px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{height:80px;border:1px solid #ddd;margin:4px;cursor:pointer}
    .entry{display:flex;align-items:flex-start;gap:8px;padding:6px;border:1px solid #eee;margin-bottom:6px}
    .gallery{display:flex;flex-wrap:wrap}
    label{font-weight:600}
    input[type=text]{padding:6px;min-width:200px}
    textarea{width:100%;height:120px}
  </style>
</head>
<body>
  <h1>記録用ツール</h1>
  <p id="recordCount">記録数: 0</p>
  <div class="controls">
    <button id="captureScreenBtn">画面キャプチャ</button>
    <button id="exportJsonBtn">JSONエクスポート</button>
    <button id="exportZipBtn">画像 + CSV を ZIP でエクスポート</button>
    <button id="clearAllBtn">すべてクリア</button>
  </div>

  <div id="entries"></div>

  <h2>記録</h2>
  <div id="gallery" class="gallery"></div>

  <h2>デバッグログ</h2>
  <textarea id="log" readonly></textarea>

<script>
const entries = []; // {id, dataUrl, reading, memo, ts}
const logEl = document.getElementById('log');
function log(t){ logEl.value += new Date().toLocaleString() + ' - ' + t + '\n'; logEl.scrollTop = logEl.scrollHeight }

function saveToLocal(){
  localStorage.setItem('kanji_records', JSON.stringify(entries));
}

function loadFromLocal(){
  const raw = localStorage.getItem('kanji_records');
  if(raw){
    try{
      const arr = JSON.parse(raw);
      entries.splice(0, entries.length, ...arr);
      refreshUI();
      log('前回のデータを復元しました');
    }catch(e){ log('復元エラー: '+e); }
  }
}

function refreshUI(){
  const gallery = document.getElementById('gallery');
  gallery.innerHTML='';
  const entriesEl = document.getElementById('entries');
  entriesEl.innerHTML='';
  entries.forEach((e,i)=>{
    const div = document.createElement('div'); div.className='entry';
    const img = document.createElement('img'); img.src=e.dataUrl; img.className='thumb';
    img.title = e.reading;
    img.onclick = ()=>{
      const newReading = prompt('...', e.reading);
      if(newReading!==null){ e.reading = newReading; saveToLocal(); refreshUI(); }
    };
    const info = document.createElement('div');
    const readingInput = document.createElement('input');
    readingInput.type='text'; readingInput.value=e.reading;
    readingInput.onchange=()=>{ e.reading = readingInput.value; saveToLocal(); };
    const memoInput = document.createElement('textarea');
    memoInput.placeholder='メモ';
    memoInput.value = e.memo||'';
    memoInput.onchange=()=>{ e.memo = memoInput.value; saveToLocal(); };
    info.appendChild(document.createTextNode('読み:'));
    info.appendChild(readingInput);
    info.appendChild(document.createElement('br'));
    info.appendChild(document.createTextNode('メモ:'));
    info.appendChild(memoInput);
    info.appendChild(document.createElement('br'));
    const time = document.createElement('div');
    time.innerHTML = `<small>${new Date(e.ts).toLocaleString()}</small>`;
    info.appendChild(time);
    const del = document.createElement('button'); del.textContent='削除'; del.onclick=()=>{ entries.splice(i,1); saveToLocal(); refreshUI(); };
    const download = document.createElement('a'); download.textContent='画像保存'; download.href=e.dataUrl; download.download=`kanji_${i+1}.png`;
    info.appendChild(document.createElement('br'));
    info.appendChild(download);
    div.appendChild(img); div.appendChild(info); div.appendChild(del);
    entriesEl.appendChild(div);

    const thumb = img.cloneNode();
    gallery.appendChild(thumb);
  });
  saveToLocal();
}

// 画面キャプチャ
document.getElementById('captureScreenBtn').addEventListener('click', async ()=>{
  try{
    const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const frame = await imageCapture.grabFrame();
    const canvas = document.createElement('canvas');
    canvas.width = frame.width; canvas.height = frame.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(frame,0,0);
    const dataUrl = canvas.toDataURL('image/png');
    track.stop();
    promptAndSave(dataUrl);
    log('画面キャプチャ完了');
  }catch(err){ log('画面キャプチャに失敗: '+err); }
});

function promptAndSave(dataUrl){
  const reading = window.prompt('...');
  const entry = { id: Date.now(), dataUrl, reading: reading || '', memo:'', ts: Date.now() };
  entries.push(entry);
  refreshUI();
  log('エントリ保存: ' + entry.reading);
}

// JSON エクスポート
document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
  const minimal = entries.map((e,i)=>({index:i+1,reading:e.reading,memo:e.memo,ts:e.ts,filename:`kanji_${i+1}.png`}));
  const blob = new Blob([JSON.stringify({meta:minimal},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kanji_records.json'; a.click();
  log('JSON エクスポート');
});

// ZIP エクスポート
document.getElementById('exportZipBtn').addEventListener('click', async ()=>{
  if(entries.length===0){ alert('エントリがありません'); return }
  const zip = new JSZip();
  const csvRows = [['index','filename','reading','memo','timestamp']];
  for(let i=0;i<entries.length;i++){
    const e = entries[i];
    const filename = `kanji_${i+1}.png`;
    const blob = dataURLtoBlob(e.dataUrl);
    zip.file(filename, blob);
    csvRows.push([i+1,filename,`"${e.reading.replace(/"/g,'""') }"`,`"${(e.memo||'').replace(/"/g,'""') }"`, new Date(e.ts).toISOString()]);
  }
  const csv = csvRows.map(r=>r.join(',')).join('\n');
  zip.file('kanji_records.csv', csv);
  const content = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = 'kanji_records.zip'; a.click();
  log('ZIP エクスポート完了');
});

function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
  const bstr = atob(arr[1]); let n = bstr.length; const u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], {type:mime});
}

function updateRecordCount() {
  const data = JSON.parse(localStorage.getItem("records")) || [];
  document.getElementById("recordCount").textContent = "記録数: " + data.length;
}

// ページを開いたときに実行
window.addEventListener("load", updateRecordCount);
  
document.getElementById('clearAllBtn').addEventListener('click', ()=>{
  if(!confirm('全データを本当に削除しますか？')) return;
  entries.length=0; refreshUI(); log('すべてクリア');
});

loadFromLocal();
log('ツール読み込み完了');
  
updateRecordCount();

</script>
</body>
</html>
