<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Page not found - Github Pages</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;margin:16px}
button{margin:4px}
.gallery{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.thumb-container{border:1px solid #ddd;padding:4px;width:150px;display:flex;flex-direction:column;align-items:center;cursor:pointer}
.thumb-container img{width:100%;height:auto}
.thumb-container div{margin-top:2px;word-break:break-word;text-align:center}
</style>
</head>
<body>

<h1>記録</h1>
<p id="recordCount">記録数: 0</p>
<button id="captureBtn">画面キャプチャ</button>
<button id="clearBtn">全削除</button>

<div id="gallery" class="gallery"></div>

<script>
const entries = []; // {id, dataUrl, reading, memo, ts}

// localStorage 保存
function saveToLocal(){
    localStorage.setItem('kanji_records', JSON.stringify(entries));
    updateRecordCount();
}

// localStorage 読み込み
function loadFromLocal(){
    const raw = localStorage.getItem('kanji_records');
    if(raw){
        try{
            const arr = JSON.parse(raw);
            entries.splice(0, entries.length, ...arr);
            refreshGallery();
        }catch(e){ console.error('復元エラー:', e); }
    }
}

function updateRecordCount(){
    document.getElementById('recordCount').textContent = "記録数: " + entries.length;
}

// ギャラリー更新
function refreshGallery(){
    const gallery = document.getElementById('gallery');
    gallery.innerHTML = '';
    entries.forEach((e,i)=>{
        const div = document.createElement('div');
        div.className = 'thumb-container';

        const img = document.createElement('img');
        img.src = e.dataUrl;
        div.appendChild(img);

        const reading = document.createElement('div');
        reading.textContent = "読み: " + (e.reading||"");
        div.appendChild(reading);

        const memo = document.createElement('div');
        memo.textContent = "メモ: " + (e.memo||"");
        div.appendChild(memo);

        // クリックで編集
        div.addEventListener('click', ()=>{
            const newReading = prompt('読みを編集', e.reading||'') || e.reading;
            const newMemo = prompt('メモを編集', e.memo||'') || e.memo;
            e.reading = newReading;
            e.memo = newMemo;
            saveToLocal();
            refreshGallery();
        });

        gallery.appendChild(div);
    });
}

// 他タブ/他ウィンドウのスクリーンショット
document.getElementById('captureBtn').addEventListener('click', async ()=>{
    try{
        const stream = await navigator.mediaDevices.getDisplayMedia({video:true});
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();

        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap,0,0);
        const dataUrl = canvas.toDataURL('image/png');

        track.stop(); // ストリーム停止

        // 画像のみ保存
        entries.push({id: Date.now(), dataUrl, reading:"", memo:"", ts: Date.now()});
        saveToLocal();
        refreshGallery();

    }catch(e){
        alert('画面キャプチャに失敗しました');
        console.error(e);
    }
});

// 全削除
document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(confirm('全データを本当に削除しますか？')){
        entries.length = 0;
        saveToLocal();
        refreshGallery();
    }
});

// 初期化
loadFromLocal();
updateRecordCount();

</script>
</body>
</html>
