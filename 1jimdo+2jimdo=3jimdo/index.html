<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Page not found - Github Pages</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;margin:16px}
button{margin:4px}
.gallery{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.thumb-container{border:1px solid #ddd;padding:4px;width:150px;display:flex;flex-direction:column;align-items:center;cursor:pointer}
.thumb-container img{width:100%;height:auto}
.thumb-container div{margin-top:2px;word-break:break-word;text-align:center}
textarea#log{width:100%;height:150px;margin-top:8px}
</style>
</head>
<body>

<h1>記録</h1>
<p id="recordCount">記録数: 0</p>
<div>
<button id="captureBtn">画面キャプチャ</button>
<button id="stopStreamBtn">画面共有停止</button>
<button id="clearBtn">削除</button>
<button id="exportBtn">HTMLエクスポート</button>
<button id="exportJsonBtn">JSONエクスポート</button>
</div>

<div id="gallery" class="gallery"></div>

<h2>キャプチャログ</h2>
<textarea id="log" readonly></textarea>

<script>
let displayStream = null; // 画面共有ストリーム
const logEl = document.getElementById('log');

// IndexedDB 操作
function openDB(){
    return new Promise((resolve,reject)=>{
        const req = indexedDB.open("kanjiDB",1);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains("entries")){
                db.createObjectStore("entries",{keyPath:"id"});
            }
        };
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e);
    });
}

async function saveEntry(entry){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
        const tx = db.transaction("entries","readwrite");
        const store = tx.objectStore("entries");
        const req = store.put(entry);
        req.onsuccess = ()=>resolve();
        req.onerror = e=>reject(e);
    });
}

async function getAllEntries(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
        const tx = db.transaction("entries","readonly");
        const store = tx.objectStore("entries");
        const req = store.getAll();
        req.onsuccess = e=>resolve(e.target.result);
        req.onerror = e=>reject(e);
    });
}

async function clearAllEntries(){
    const db = await openDB();
    return new Promise((resolve,reject)=>{
        const tx = db.transaction("entries","readwrite");
        const store = tx.objectStore("entries");
        const req = store.clear();
        req.onsuccess = ()=>resolve();
        req.onerror = e=>reject(e);
    });
}

// ログ出力
function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.value += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

// ギャラリー更新
async function refreshGallery(){
    const gallery = document.getElementById('gallery');
    gallery.innerHTML='';
    const entries = await getAllEntries();
    document.getElementById('recordCount').textContent = "記録数: " + entries.length;

    entries.forEach(e=>{
        const div = document.createElement('div');
        div.className='thumb-container';

        const img = document.createElement('img');
        img.src = URL.createObjectURL(e.blob);
        div.appendChild(img);

        const readingDiv = document.createElement('div');
        readingDiv.textContent = "読み: " + (e.reading||"");
        div.appendChild(readingDiv);

        const memoDiv = document.createElement('div');
        memoDiv.textContent = "メモ: " + (e.memo||"");
        div.appendChild(memoDiv);

        div.addEventListener('click', async ()=>{
            const newReading = prompt('読みを編集', e.reading||'')||e.reading;
            const newMemo = prompt('メモを編集', e.memo||'')||e.memo;
            e.reading = newReading;
            e.memo = newMemo;
            await saveEntry(e);
            await refreshGallery();
            log('エントリ編集: ' + e.reading);
        });

        gallery.appendChild(div);
    });
}

// 画面キャプチャ
document.getElementById('captureBtn').addEventListener('click', async ()=>{
    try{
        if(!displayStream){
            displayStream = await navigator.mediaDevices.getDisplayMedia({video:true});
            log('画面共有ストリーム取得成功');
        }
        const track = displayStream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();

        const scale = 0.5;
        const canvas = document.createElement('canvas');
        canvas.width = bitmap.width * scale;
        canvas.height = bitmap.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(bitmap,0,0,canvas.width,canvas.height);

        canvas.toBlob(async blob=>{
            const entry = {id: Date.now(), blob, reading:"", memo:"", ts: Date.now()};
            await saveEntry(entry);
            await refreshGallery();
            log('キャプチャ成功');
        },'image/png');
    }catch(e){
        log('キャプチャ失敗: '+e);
        console.error(e);
        alert('画面キャプチャに失敗しました');
    }
});

// 画面共有停止
document.getElementById('stopStreamBtn').addEventListener('click', ()=>{
    if(displayStream){
        displayStream.getTracks().forEach(t=>t.stop());
        displayStream = null;
        log('画面共有ストリーム停止');
    }else{
        log('画面共有ストリームは存在しません');
    }
});

// 全削除
document.getElementById('clearBtn').addEventListener('click', async ()=>{
    if(confirm('データを本当に削除しますか？')){
        await clearAllEntries();
        await refreshGallery();
        log('データ削除');
    }
});

// Blob -> DataURL
function blobToDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('blob->dataURL 変換失敗'));
        reader.readAsDataURL(blob);
    });
}

// HTMLエクスポート
async function exportToHTML() {
    try {
        const entries = await getAllEntries();
        if (!entries || entries.length === 0) {
            alert('エクスポートするデータがありません。');
            return;
        }

        log('HTMLエクスポート開始: ' + entries.length + ' 件');

        let htmlContent = `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>漢字記録（エクスポート）</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;margin:16px}
.gallery{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.thumb-container{border:1px solid #ddd;padding:4px;width:150px;display:flex;flex-direction:column;align-items:center}
.thumb-container img{width:100%;height:auto}
.thumb-container div{margin-top:2px;word-break:break-word;text-align:center}
</style>
</head>
<body>
<h1>漢字記録（エクスポート）</h1>
<div id="gallery" class="gallery">
`;

        for (let i = 0; i < entries.length; i++) {
            const e = entries[i];
            log(`変換中 ${i+1}/${entries.length} ...`);
            const dataURL = await blobToDataURL(e.blob);
            htmlContent += `
<div class="thumb-container">
  <img src="${dataURL}" alt="screenshot ${i+1}">
  <div>読み: ${(e.reading||'')}</div>
  <div>メモ: ${(e.memo||'')}</div>
  <div><small>${new Date(e.ts).toLocaleString()}</small></div>
</div>
`;
        }

        htmlContent += `</div></body></html>`;

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kanji_records.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        log('HTMLエクスポート完了');
        alert('HTMLエクスポート完了');
    } catch (err) {
        console.error(err);
        log('HTMLエクスポート失敗: ' + err);
        alert('エクスポート中にエラーが発生しました');
    }
}

// JSONエクスポート（独立関数）
async function exportToJSON() {
    try {
        const entries = await getAllEntries();
        if (!entries || entries.length === 0) {
            alert('エクスポートするデータがありません。');
            return;
        }

        log('JSONエクスポート開始: ' + entries.length + ' 件');

        let data = [];
        for (let i = 0; i < entries.length; i++) {
            const e = entries[i];
            log(`変換中 ${i+1}/${entries.length} ...`);
            const dataURL = await blobToDataURL(e.blob);
            data.push({
                id: e.id,
                reading: e.reading || "",
                memo: e.memo || "",
                ts: e.ts,
                image: dataURL
            });
        }

        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().replace(/[:.]/g, "-");
        a.download = `kanji_records_${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        log('JSONエクスポート完了');
        alert('JSONエクスポート完了');
    } catch (err) {
        console.error(err);
        log('JSONエクスポート失敗: ' + err);
        alert('JSONエクスポート中にエラーが発生しました');
    }
}

// ボタンイベント登録
document.getElementById('captureBtn').addEventListener('click', async ()=>{/* ... 省略 ... */});
document.getElementById('stopStreamBtn').addEventListener('click', ()=>{/* ... 省略 ... */});
document.getElementById('clearBtn').addEventListener('click', async ()=>{/* ... 省略 ... */});
document.getElementById('exportBtn').addEventListener('click', exportToHTML);
document.getElementById('exportJsonBtn').addEventListener('click', exportToJSON);

// 初期化
refreshGallery();

</script>
</body>
</html>
